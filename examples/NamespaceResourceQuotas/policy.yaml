apiVersion: magalix.com/v1
kind: Policy
metadata:
  name: magalix.policies.namespace-missing-resource-quota
spec:
  enable: true
  name: magalix.policies.namespace-missing-resource-quota
  description: |
    When creating resource quotas per namespace, ensure CPU and Memory requests and limits are set.
  how_to_solve: |
    Declare values for CPU & Memory requests and limits.  
    ```
    spec:
      hard:
        requests.cpu: <size>
        requests.memory: <size>
        limits.cpu: <size>
        limits.memory: <size>
    ```
    https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/quota-memory-cpu-namespace/
  category: magalix.categories.capacity-management
  severity: medium
  controls:
  - magalix.controls.soc2-type-1.2.1.1
  parameters:
  - name: resource_type
    type: string
    required: true
    default:
  - name: resource_setting
    type: string
    required: true
    default:
  code: "package magalix.advisor.namespace.resource_quotas\n\nresource_type := input.parameters.resource_type\n\
    resource_setting := input.parameters.resource_setting\n\nviolation[result] {\n\
    \  not rq_spec.hard[resource_setting][resource_type]\n  result = {\n  \t\"issue\
    \ detected\": true,\n    \"msg\": sprintf(\"You are missing '%v' '%v'\", [resource_type,\
    \ resource_setting]),\n    \"violating_key\": \"spec.hard\"\n  }\n}\n\nrq_spec\
    \ = input.review.object.spec{\n  contains_kind(input.review.object.kind, {\"ResourceQuota\"\
    })\n} \n\ncontains_kind(kind, kinds) {\n  kinds[_] = kind\n}\n"
