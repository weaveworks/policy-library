apiVersion: magalix.com/v1
kind: Policy
metadata:
  name: magalix.policies.node-kernel-versions
spec:
  id: magalix.policies.node-kernel-versions
  name: Node Kernel Versions
  description: |
    This Policy allows you to select the type of OS image you have, the minimum kernel version
  how_to_solve:
  category: magalix.categories.organizational-standards
  severity: medium
  controls:
  - magalix.controls.soc2-type-1.1.6.8
  parameters:
  - name:
    type: array
    required: true
    default:
  code: "package magalix.advisor.nodes.outdated_kernel_version\n\n  kernel_latest_versions\
    \ := {\n    \"Amazon Linux 2\": {\n        \"4.14\":\"4.14.193\"\n    },\n  \t\
    \"Container-Optimized OS from Google\": {\n        \"4.14\":\"4.14.174\", \n \
    \       \"4.19\":\"4.19.122\", \n        \"5.4\":\"5.4.49\"\n    },\n    \"default\"\
    : {\n        \"4.4\":\"4.4.240\", \n        \"4.9\":\"4.9.240\",\n        \"4.14\"\
    :\"4.14.202\",\n        \"4.19\":\"4.19.152\", \n        \"5.4\":\"5.4.72\",\n\
    \        \"5.8\":\"5.8.16\",\n        \"5.9\":\"5.9.1\"\n    }\n  }\n  \n  osImage\
    \ := input.review.object.status.nodeInfo.osImage\n       \n  image = osImage {\n\
    \  \tkernel_latest_versions[osImage]\n  } else = \"default\" {\n    not kernel_latest_versions[osImage]\n\
    \  }\n    \n  \n  kernel_version := regex.split(\"[-|+]\", input.review.object.status.nodeInfo.kernelVersion)[0]\n\
    \  kernel_version_list := regex.split(\"[.]\", kernel_version)\n  \n  \n  major_version\
    \ := concat(\".\", [kernel_version_list[0], kernel_version_list[1]])\n  latest_kernel\
    \ := kernel_latest_versions[image][major_version]\n\nviolation[result] {\n  verify\
    \ := semver.compare(kernel_version, latest_kernel)\n  verify < 0\n  \n  result\
    \ = {\n    \"issue detected\": true,\n    \"osImage\": osImage,\n    \"kernel_version\"\
    : kernel_version,\n    \"latest_kernel\": latest_kernel,\n    \"msg\": \"You are\
    \ running an older version of the Linux kernel\",\n    \"violating_key\": \"status.nodeInfo.kernelVersion\"\
    \n    }\n}"
