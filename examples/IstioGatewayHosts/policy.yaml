apiVersion: magalix.com/v1
kind: Policy
metadata:
  name: magalix.policies.istio-gateway-approved-hosts
spec:
  name: magalix.policies.istio-gateway-approved-hosts
  description: |
    # Istio Gateway Approved Hosts
    This ensures you are only serving traffic for approved hostnames. 
  how_to_solve: |
    Ensure your domain name is the same as the one you are hosting.
  category: magalix.categories.network-security
  severity: high
  parameters:
  - name: hostnames
    type: array
    required: true
    default:
  code: "package magalix.advisor.istio.approved_hosts\n\nhostnames := input.parameters.hostnames\n\
    \nviolation[result] {\n  servers := gateway_spec.servers[_]\n  hosts := servers.hosts[_]\n\
    \  not array_contains(hostnames, hosts)\n  result = {\n    \"issue detected\"\
    : true,\n    \"msg\": sprintf(\"You have specified hosts: '%v'; detected '%v'\"\
    , [hostnames, hosts]),\n    \"violating_key\": \"spec.servers.hosts\"\n  }\n}\n\
    \narray_contains(array, element) {\n  array[_] = element\n}\n\n# controller_container\
    \ acts as an iterator to get containers from the template\ngateway_spec = input.review.object.spec\
    \ {\n  contains_kind(input.review.object.kind, {\"Gateway\"})\n} \n\ncontains_kind(kind,\
    \ kinds) {\n  kinds[_] = kind\n}\n\n\n"
