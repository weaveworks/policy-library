name: magalix.policies.postgres-enforce-environment-variable
description: |
  This Policy checks for specific environment variables when you are using the official container image from Docker Hub. 
  ### POSTGRES_PASSWORD
  The POSTGRES_PASSWORD environment variable is required for you to use the PostgreSQL image. It must not be empty or undefined. This environment variable sets the superuser password for PostgreSQL. The default superuser is defined by the POSTGRES_USER environment variable.
  ### POSTGRES_USER     
  The POSTGRES_USER environment variable is used in conjunction with POSTGRES_PASSWORD to set a user and its password. This variable will create the specified user with superuser power and a database with the same name. If it is not specified, then the default user of postgres will be used.

  Be aware that if this parameter is specified, PostgreSQL will still show The files belonging to this database system will be owned by user "postgres" during initialization. This refers to the Linux system user (from /etc/passwd in the image) that the postgres daemon runs as, and as such is unrelated to the POSTGRES_USER option. See the section titled "Arbitrary --user Notes" for more details.

  ### POSTGRES_HOST_AUTH_METHOD
  The POSTGRES_HOST_AUTH_METHOD environment variable is used to control the auth-method for host connections for all databases, all users, and all addresses. If unspecified then md5 password authentication is used. 
how_to_solve: |
  If you encounter a violation, ensure one of the following environment variables is set. 
  - POSTGRES_PASSWORD
  - POSTGRES_USER 
  - POSTGRES_HOST_AUTH_METHOD

  For futher information about the Postgres Docker container, check here: https://hub.docker.com/_/postgres
category: magalix.categories.access-control
severity: high
controls:
- magalix.controls.hipaa.164.312.a.2.i
- magalix.controls.gdpr.25
- magalix.controls.gdpr.32
- magalix.controls.gdpr.24
- magalix.controls.hipaa.164.312.a.1
parameters:
- default:
  name: envvar_name
  required: true
  type: string
- default:
  name: app_name
  required: true
  type: string
- default:
  name: exclude_namespace
  required: false
  type: string
- default:
  name: exclude_label_key
  required: false
  type: string
- default:
  name: exclude_label_value
  required: false
  type: string
