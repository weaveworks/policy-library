apiVersion: magalix.com/v1
kind: Policy
metadata:
  name: magalix.policies.persistent-volume-max-size
spec:
  id: magalix.policies.persistent-volume-max-size
  name: Persistent Volume Max Size
  description: |
    This Policy sets a max size on your Persistent Volumes. When specifying a size, be sure to include the size and sizing suffix (e.g. 1Gi).
  how_to_solve: |
    Ensure the max size (e.g. 5Gi) on your persistent volume is no larger than what is specified in the Policy. 
    ```
    spec:
      capacity:
        storage: <size>
    ```
  category: magalix.categories.capacity-management
  severity: medium
  controls:
  - magalix.controls.soc2-type-1.2.1.1
  parameters:
  - name: size
    type: string
    required: true
    default:
  - name: exclude_label_key
    type: string
    required: false
    default:
  - name: exclude_label_value
    type: string
    required: false
    default:
  code: "package magalix.advisor.storage.persistentvolume_max_size\n\nmax_size :=\
    \ input.parameters.size\nexclude_label_key := input.parameters.exclude_label_key\n\
    exclude_label_value := input.parameters.exclude_label_value\n\nviolation[result]\
    \ {\n  not exclude_label_value == controller_input.metadata.labels[exclude_label_key]\n\
    \  storage_value := storage_spec.capacity.storage\n  unit_type_value := units.parse_bytes(storage_value)\n\
    \  unit_max_value := units.parse_bytes(max_size)\n  unit_max_value < unit_type_value\n\
    \  result = {\n    \"issue detected\": true,\n    \"msg\": sprintf(\"Storage capacity\
    \ must be a maximum of '%v'; found '%v'\", [max_size, storage_value]),\n    \"\
    violating_key\": \"spec.capacity.storage\",\n    \"recommended_value\": max_size\n\
    \  }\n}\n\n# Controller input\ncontroller_input = input.review.object\n\n# controller_container\
    \ acts as an iterator to get containers from the template\nstorage_spec = controller_input.spec\
    \ {\n  contains_kind(controller_input.kind, {\"PersistentVolume\"})\n}\n\ncontains_kind(kind,\
    \ kinds) {\n  kinds[_] = kind\n}\n"
