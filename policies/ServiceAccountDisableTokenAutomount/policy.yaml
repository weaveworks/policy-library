apiVersion: pac.weave.works/v1
kind: Policy
metadata:
  name: weave.policies.disable-service-account-token-automount-in-specific-namespace
spec:
  id: weave.policies.disable-service-account-token-automount-in-specific-namespace
  name: Disable ServiceAccount Token Automount In Specific Namespace
  description: |
    This Policy allows you to enforce the enabling or disabling the automounting of service account tokens. 

    When a pod is created without a service account defined, the default service account within the same namespace will be assigned automatically. 

    This is a security concern because a kubernetes client can load a container's service account token. With that token a compromoised contaienr can then access the Kubernetes API to perform actions such as creating and deleting pods.

    In version 1.6+, you can opt out of automounting API credentials for a service account by setting automountServiceAccountToken: false on the service account.
  how_to_solve: |
    Add the key:value pair `automountServiceAccountToken: false` to your Service Account declaration. 
    ```
    kind: ServiceAccount
    automountServiceAccountToken: false
    ```

    https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server
  category: weave.categories.access-control
  severity: high
  targets: {kinds: [ServiceAccount]}
  controls:
  - weave.controls.pci-dss.7.1.1
  - weave.controls.cis-benchmark.5.1.6
  - weave.controls.mitre-attack.6.3
  - weave.controls.hipaa.164.312.a.2.i
  - weave.controls.gdpr.25
  - weave.controls.gdpr.32
  - weave.controls.gdpr.24
  - weave.controls.hipaa.164.312.a.1
  - weave.controls.soc2-type-i.1.6.3
  tags: [pci-dss, cis-benchmark, mitre-attack, hipaa, gdpr, default, soc2-type1]
  parameters:
  - name: automount
    type: boolean
    required: true
    value: false
  - name: namespace
    type: string
    required: true
    value: default
  - name: exclude_label_key
    type: string
    required: false
    value:
  - name: exclude_label_value
    type: string
    required: false
    value:
  enabled: true
