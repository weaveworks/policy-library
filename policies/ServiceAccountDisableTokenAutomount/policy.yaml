apiVersion: magalix.com/v1
kind: Policy
metadata:
  name: magalix.policies.disable-service-account-token-automount-in-specific-namespace
spec:
  enable: true
  name: magalix.policies.disable-service-account-token-automount-in-specific-namespace
  description: |
    This Policy allows you to enforce the enabling or disabling the automounting of service account tokens. 

    When a pod is created without a service account defined, the default service account within the same namespace will be assigned automatically. 

    This is a security concern because a kubernetes client can load a container's service account token. With that token a compromoised contaienr can then access the Kubernetes API to perform actions such as creating and deleting pods.

    In version 1.6+, you can opt out of automounting API credentials for a service account by setting automountServiceAccountToken: false on the service account.
  how_to_solve: |
    Add the key:value pair `automountServiceAccountToken: false` to your Service Account declaration. 
    ```
    kind: ServiceAccount
    automountServiceAccountToken: false
    ```

    https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server
  category: magalix.categories.access-control
  severity: high
  targets: {kind: [ServiceAccount]}
  controls:
  - magalix.controls.pci-dss.7.1.1
  - magalix.controls.cis-benchmark.5.1.6
  - magalix.controls.mitre-attack.6.3
  - magalix.controls.hipaa.164.312.a.2.i
  - magalix.controls.gdpr.25
  - magalix.controls.gdpr.32
  - magalix.controls.gdpr.24
  - magalix.controls.hipaa.164.312.a.1
  - magalix.controls.soc2-type-1.1.6.3
  tags: [pci-dss, cis-benchmark, mitre-attack, hipaa, gdpr, default, soc2-type1]
  parameters:
  - name: automount
    type: boolean
    required: true
    default: false
  - name: namespace
    type: string
    required: true
    default: default
  - name: exclude_label_key
    type: string
    required: false
    default:
  - name: exclude_label_value
    type: string
    required: false
    default:
  code: "package magalix.advisor.sa.disable_default_service_account_token_automount\n\
    \nautomount_value = input.parameters.automount\nnamespace = input.parameters.namespace\n\
    exclude_label_key := input.parameters.exclude_label_key\nexclude_label_value :=\
    \ input.parameters.exclude_label_value\n\nviolation[result] {\n  not exclude_label_value\
    \ == sa_input.metadata.labels[exclude_label_key]\n  sa_input.metadata.name ==\
    \ \"default\"\n  namespace == sa_input.metadata.namespace\n  automount := sa_input\n\
    \  not has_key(automount, \"automountServiceAccountToken\")\n  result = {\n  \
    \  \"issue detected\": true,\n    \"msg\": sprintf(\"'automountServiceAccountToken'\
    \ must be set; found '%v'\",[automount]),\n    \"violating_key\": \"\"\n  }\n\
    }\n\nviolation[result] {\n  not exclude_label_value == sa_input.metadata.labels[exclude_label_key]\n\
    \  sa_input.metadata.name == \"default\"\n  namespace == sa_input.metadata.namespace\n\
    \  automount := sa_input.automountServiceAccountToken\n  not automount_value =\
    \ automount\n  result = {\n    \"issue detected\": true,\n    \"msg\": sprintf(\"\
    automountServiceAccountToken must be set to '%v'; found '%v'\",[automount_value,\
    \ automount]),\n    \"violating_key\":\"automountServiceAccountToken\",\n    \"\
    recommended_value\": automount_value\n  }\n}\n\nhas_key(x, k) { \n  type_name(x[k])\n\
    }\n\nsa_input = input.review.object {\n  contains_kind(input.review.object.kind,\
    \ {\"ServiceAccount\"})\n}\n\ncontains_kind(kind, kinds) {\n  kinds[_] = kind\n\
    }"
