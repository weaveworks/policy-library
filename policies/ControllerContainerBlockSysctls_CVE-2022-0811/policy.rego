package weave.advisor.podSecurity.block_sysctls.CVE_2022_0811

import future.keywords.in

exclude_namespaces := input.parameters.exclude_namespaces
exclude_label_key := input.parameters.exclude_label_key
exclude_label_value := input.parameters.exclude_label_value

# Container security context
violation[result] {
	isExcludedNamespace == false
	not exclude_label_value == controller_input.metadata.labels[exclude_label_key]
    checkSysctls(controller_spec.securityContext.sysctls[_])
	result = {
		"issue detected": true,
		"msg": "Please check spec.template.spec.securityContext.sysctls for violating value. Reference: CVE-2022-0811",
		"violating_key": "spec.template.spec.securityContext.sysctls"
	}
}


###### Functions
isArrayContains(array, str) {
	array[_] = str
}

checkSysctls(sysctls) {
    contains(sysctls.value, "+")
    contains(sysctls.value, "=")
}

# Initial Setup
controller_input = input.review.object

controller_spec = controller_input.spec.template.spec {
	isArrayContains({"StatefulSet", "DaemonSet", "Deployment", "Job", "ReplicaSet"}, controller_input.kind)
} else = controller_input.spec {
	controller_input.kind == "Pod"
} else = controller_input.spec.jobTemplate.spec.template.spec {
	controller_input.kind == "CronJob"
}

isExcludedNamespace = true {
	controller_input.metadata.namespace
	controller_input.metadata.namespace in exclude_namespaces
} else = false
