apiVersion: pac.weave.works/v2beta1
kind: Policy
metadata:
  name: weave.policies.container-block-sysctl.cve-2022-0811
spec:
  id: weave.policies.container-block-sysctl.cve-2022-0811
  name: Container Block Sysctls CVE-2022-0811
  enabled: true
  description: "Setting sysctls can allow containers unauthorized escalated privileges to a Kubernetes node. \n"
  how_to_solve: "You should not set `securityContext.sysctls.value` to include `+` or `=` characters. \n```\n...\n  spec:\n    securityContext:\n      sysctls: \n        - name: name\n          value \"1+2=3\"\n```\n```\nhttps://kubernetes.io/docs/tasks/configure-pod-container/security-context/\nhttps://www.crowdstrike.com/blog/cr8escape-new-vulnerability-discovered-in-cri-o-container-engine-cve-2022-0811/\n"
  category: weave.categories.pod-security
  severity: high
  targets: {kinds: [Deployment, Job, ReplicationController, ReplicaSet, DaemonSet, StatefulSet, CronJob]}
  standards:
    - id: weave.standards.pci-dss
      controls:
        - weave.controls.pci-dss.2.2.4
        - weave.controls.pci-dss.2.2.5
    - id: weave.standards.cis-benchmark
      controls:
        - weave.controls.cis-benchmark.5.2.6
    - id: weave.standards.mitre-attack
      controls:
        - weave.controls.mitre-attack.4.1
    - id: weave.standards.nist-800-190
      controls:
        - weave.controls.nist-800-190.3.3.1
    - id: weave.standards.gdpr
      controls:
        - weave.controls.gdpr.24
        - weave.controls.gdpr.25
        - weave.controls.gdpr.32
  tags: [pci-dss, cis-benchmark, mitre-attack, nist800-190, gdpr, default]
  parameters:
    - name: exclude_namespaces
      type: array
      required: false
      value: [kube-system]
    - name: exclude_label_key
      type: string
      required: false
      value:
    - name: exclude_label_value
      type: string
      required: false
      value:
  code: |
    package weave.advisor.podSecurity.block_sysctls.CVE_2022_0811

    import future.keywords.in

    exclude_namespaces := input.parameters.exclude_namespaces
    exclude_label_key := input.parameters.exclude_label_key
    exclude_label_value := input.parameters.exclude_label_value

    # Container security context
    violation[result] {
    	isExcludedNamespace == false
    	not exclude_label_value == controller_input.metadata.labels[exclude_label_key]
        checkSysctls(controller_spec.securityContext.sysctls[_])
    	result = {
    		"issue detected": true,
    		"msg": "Please check spec.template.spec.securityContext.sysctls for violating value. Reference: CVE-2022-0811",
    		"violating_key": "spec.template.spec.securityContext.sysctls"
    	}
    }


    ###### Functions
    isArrayContains(array, str) {
    	array[_] = str
    }

    checkSysctls(sysctls) {
        contains(sysctls.value, "+")
        contains(sysctls.value, "=")
    }

    # Initial Setup
    controller_input = input.review.object

    controller_spec = controller_input.spec.template.spec {
    	isArrayContains({"StatefulSet", "DaemonSet", "Deployment", "Job", "ReplicaSet"}, controller_input.kind)
    } else = controller_input.spec {
    	controller_input.kind == "Pod"
    } else = controller_input.spec.jobTemplate.spec.template.spec {
    	controller_input.kind == "CronJob"
    }

    isExcludedNamespace = true {
    	controller_input.metadata.namespace
    	controller_input.metadata.namespace in exclude_namespaces
    } else = false
