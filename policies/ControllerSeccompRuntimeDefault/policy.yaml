apiVersion: magalix.com/v1
kind: Policy
metadata:
  name: magalix.policies.containers-not-using-runtime-default-seccomp-profile
spec:
  id: magalix.policies.containers-not-using-runtime-default-seccomp-profile
  name: Containers Not Using Runtime Default Seccomp Profile
  description: |
    This Policy checks for runtime/default seccomp annotation. 

    Seccomp stands for secure computing mode and has been a feature of the Linux kernel since version 2.6.12. It can be used to sandbox the privileges of a process, restricting the calls it is able to make from userspace into the kernel. Kubernetes lets you automatically apply seccomp profiles loaded onto a Node to your Pods and containers.
  how_to_solve: |
    Depending on the version of Kubernetes, you either need to set an annotation or a seccomp type in your `securityContext`. 
    ```
    metadata:
      annotations:
        seccomp.security.alpha.kubernetes.io/pod: <seccomp_annotation>
    ```
    AND
    ```
    ...
      spec:
        seccompProfile:
          type: <seccomp_type>
    ```
    https://kubernetes.io/docs/tutorials/clusters/seccomp/#create-pod-that-uses-the-container-runtime-default-seccomp-profile
  category: magalix.categories.pod-security
  severity: high
  targets: {kind: [Deployment, Job, ReplicationController, ReplicaSet, DaemonSet,
      StatefulSet, CronJob]}
  controls:
  - magalix.controls.cis-benchmark.5.7.2
  - magalix.controls.nist-800-190.4.4.3
  - magalix.controls.soc2-type-i.1.6.1
  tags: [cis-benchmark, nist800-190, soc2-type1]
  parameters:
  - name: seccomp_annotation
    type: string
    required: true
    default: runtime/default
  - name: seccomp_type
    type: string
    required: true
    default: RuntimeDefault
  - name: exclude_namespace
    type: string
    required: false
    default:
  - name: exclude_label_key
    type: string
    required: false
    default:
  - name: exclude_label_value
    type: string
    required: false
    default:
